
# ðŸ”¥ Cáº¤U HÃŒNH DATABASE (Báº®T BUá»˜C CHáº Y 1 Láº¦N)

Äá»ƒ app hoáº¡t Ä‘á»™ng Ä‘áº§y Ä‘á»§ (ÄÄƒng kÃ½, LÆ°u Ä‘iá»ƒm, PhÃ¢n tÃ­ch AI), báº¡n hÃ£y copy toÃ n bá»™ Ä‘oáº¡n code dÆ°á»›i Ä‘Ã¢y vÃ  cháº¡y trong **Supabase Dashboard > SQL Editor**.

```sql
-- ==========================================
-- 1. Dá»ŒN Dáº¸P Dá»® LIá»†U CÅ¨ (Äá»ƒ trÃ¡nh lá»—i)
-- ==========================================
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();
DROP TABLE IF EXISTS public.question_attempts CASCADE;
DROP TABLE IF EXISTS public.exam_results CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;

-- ==========================================
-- 2. Báº¢NG PROFILES (ThÃ´ng tin ngÆ°á»i dÃ¹ng)
-- ==========================================
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  email TEXT,
  phone TEXT,
  full_name TEXT,
  date_of_birth DATE,
  gender TEXT,
  avatar_url TEXT,
  role TEXT DEFAULT 'student', -- 'student', 'teacher', 'admin'
  status TEXT DEFAULT 'active', -- 'active', 'pending', 'blocked'
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public profiles are viewable by everyone" ON public.profiles FOR SELECT USING (true);
CREATE POLICY "Users can update own profile" ON public.profiles FOR UPDATE USING (auth.uid() = id);

-- ==========================================
-- 3. Báº¢NG EXAM_RESULTS (LÆ°u káº¿t quáº£ bÃ i thi/luyá»‡n táº­p)
-- ==========================================
CREATE TABLE public.exam_results (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  subject_name TEXT NOT NULL,
  grade_name TEXT NOT NULL,
  score INTEGER NOT NULL,
  total_questions INTEGER NOT NULL,
  exam_type TEXT NOT NULL, -- 'practice', 'test', 'mock'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.exam_results ENABLE ROW LEVEL SECURITY;

-- Há»c sinh chá»‰ xem vÃ  thÃªm Ä‘iá»ƒm cá»§a chÃ­nh mÃ¬nh
CREATE POLICY "Users can insert own results" ON public.exam_results FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can view own results" ON public.exam_results FOR SELECT USING (auth.uid() = user_id);

-- ==========================================
-- 4. Báº¢NG QUESTION_ATTEMPTS (LÆ°u chi tiáº¿t tá»«ng cÃ¢u lÃ m sai/Ä‘Ãºng Ä‘á»ƒ AI phÃ¢n tÃ­ch)
-- ==========================================
CREATE TABLE public.question_attempts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  question_text TEXT,
  is_correct BOOLEAN NOT NULL,
  time_taken_seconds INTEGER,
  question_topics TEXT[], -- Máº£ng cÃ¡c chá»§ Ä‘á» (VD: ["Äáº¡i sá»‘", "HÃ m sá»‘"])
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.question_attempts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can insert own attempts" ON public.question_attempts FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can view own attempts" ON public.question_attempts FOR SELECT USING (auth.uid() = user_id);

-- ==========================================
-- 5. TRIGGER Xá»¬ LÃ ÄÄ‚NG KÃ NGÆ¯á»œI DÃ™NG Má»šI
-- ==========================================
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS trigger 
LANGUAGE plpgsql 
SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  meta_role text;
  meta_name text;
  meta_dob date;
  meta_gender text;
  init_status text;
BEGIN
  meta_role := COALESCE(new.raw_user_meta_data->>'role', 'student');
  meta_name := COALESCE(new.raw_user_meta_data->>'full_name', '');
  meta_gender := COALESCE(new.raw_user_meta_data->>'gender', 'KhÃ¡c');
  
  BEGIN
    meta_dob := (new.raw_user_meta_data->>'date_of_birth')::DATE;
  EXCEPTION WHEN OTHERS THEN
    meta_dob := NULL;
  END;
  
  IF meta_role = 'teacher' THEN
    init_status := 'pending';
  ELSE
    init_status := 'active';
  END IF;

  INSERT INTO public.profiles (id, email, phone, full_name, date_of_birth, gender, role, status)
  VALUES (
    new.id, 
    new.email, 
    new.phone,
    meta_name,
    meta_dob,
    meta_gender,
    meta_role,
    init_status
  );
  RETURN new;
END;
$$;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- ==========================================
-- 6. HÃ€M Há»– TRá»¢ ADMIN (QUáº¢N TRá»Š VIÃŠN)
-- ==========================================
CREATE OR REPLACE FUNCTION get_all_profiles()
RETURNS SETOF profiles
LANGUAGE sql SECURITY DEFINER SET search_path = public
AS $$ SELECT * FROM profiles ORDER BY created_at DESC; $$;

CREATE OR REPLACE FUNCTION update_user_role(target_user_id UUID, new_role TEXT)
RETURNS void
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  UPDATE public.profiles SET role = new_role WHERE id = target_user_id;
  UPDATE auth.users SET raw_user_meta_data = 
      jsonb_set(COALESCE(raw_user_meta_data, '{}'::jsonb), '{role}', to_jsonb(new_role))
  WHERE id = target_user_id;
END;
$$;
```
